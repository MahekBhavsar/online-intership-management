<div class="container-fluid p-0 d-flex vh-100 overflow-hidden">

  <app-admin-sidebar></app-admin-sidebar>

  <div class="flex-grow-1 bg-light overflow-auto d-flex flex-column">

    <app-admin-topnav></app-admin-topnav>

    <div class="p-4 p-lg-5">

      <div class="row align-items-center mb-4">
        <div class="col">
          <h1 class="h3 fw-bold text-dark mb-1">Staff Timetable Manager</h1>
          <p class="text-secondary mb-0">Configure work hours and weekly schedules for instructors.</p>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 bg-dark text-white mb-4">
        <div class="card-body p-4">
          <div class="row align-items-end g-3">
            <div class="col-md-4">
              <label class="small text-info fw-bold mb-2">Select Staff Member</label>
              <select class="form-select border-0 shadow-sm" [ngModel]="selectedStaffId" (ngModelChange)="onStaffChange($event)">
                <option value="" disabled selected>-- Choose Staff --</option>
                @for (staff of staffList(); track staff.staffId) {
                  <option [value]="staff.staffId">{{ staff.staffName }} ({{ staff.staffId }})</option>
                }
              </select>
            </div>

            <div class="col-md-2">
              <label class="small text-light mb-2">Work Start</label>
              <input type="time" class="form-control border-0" [(ngModel)]="adminStartTime" />
            </div>

            <div class="col-md-2">
              <label class="small text-light mb-2">Work End</label>
              <input type="time" class="form-control border-0" [(ngModel)]="adminEndTime" />
            </div>

            <div class="col-md-4">
              <button class="btn btn-warning w-100 fw-bold py-2 rounded-pill shadow" (click)="generateFullWeek()" [disabled]="isLoading || !selectedStaffId">
                <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : 'fa-calendar-plus'"></i>
                {{ isLoading ? ' Generating...' : ' Generate Whole Week' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      @if (!selectedStaffId) {
        <div class="card border-0 rounded-4 shadow-sm py-5 text-center bg-white">
          <div class="py-5">
            <i class="fas fa-calendar-alt text-primary opacity-25 mb-3" style="font-size: 4rem;"></i>
            <h4 class="text-muted">Please select a staff member to view the timetable.</h4>
          </div>
        </div>
      } @else {
        <div class="row row-cols-1 row-cols-md-5 g-3">
          @for (day of daysOfWeek; track day) {
            <div class="col">
              <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden">
                <div class="card-header bg-primary text-white text-center border-0 py-2">
                  <span class="fw-bold small text-uppercase tracking-wider">{{ day }}</span>
                </div>
                <div class="card-body p-0 bg-white">
                  <table class="table table-hover table-sm mb-0">
                    <tbody>
                      @for (entry of timetableEntries(); track entry.id) {
                        @if (entry.day === day) {
                          <tr (click)="openEditModal(entry)" style="cursor: pointer;">
                            <td [class.table-success-subtle]="entry.slotType === 'free'" class="ps-3 py-3 border-bottom position-relative">
                              <div class="fw-bold text-dark" style="font-size: 0.85rem;">
                                {{ entry.startTime }} - {{ entry.endTime }}
                              </div>
                              <div class="d-flex justify-content-between align-items-center mt-1">
                                <span class="text-secondary" style="font-size: 11px;">
                                  {{ entry.subject || 'No Activity' }}
                                </span>
                                <i class="fas fa-pen text-primary opacity-50" style="font-size: 10px;"></i>
                              </div>
                              @if(entry.slotType === 'free'){
                                <span class="position-absolute top-0 end-0 p-1">
                                  <div class="bg-success rounded-circle" style="width: 6px; height: 6px;"></div>
                                </span>
                              }
                            </td>
                          </tr>
                        }
                      } @empty {
                        <tr>
                          <td class="text-center py-5 text-muted small opacity-50">
                            No slots generated.
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          }
        </div>
      }

    </div> </div> </div>

@if (selectedEntry) {
  <div class="modal-backdrop fade show"></div>
  <div class="modal d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="modal-header bg-primary text-white border-0">
          <h5 class="modal-title fw-bold">Edit Slot: {{ selectedEntry.day }}</h5>
          <button type="button" class="btn-close btn-close-white" (click)="selectedEntry = null"></button>
        </div>
        <div class="modal-body p-4">
          <div class="d-flex justify-content-between mb-4 text-muted small fw-bold">
            <span>TIME: {{ selectedEntry.startTime }} - {{ selectedEntry.endTime }}</span>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold small text-secondary">Slot Type</label>
            <select class="form-select border-0 bg-light" [(ngModel)]="selectedEntry.slotType">
              <option value="busy">Staff Work (Busy)</option>
              <option value="free">Interview / Free</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold small text-secondary">Subject / Activity Name</label>
            <input type="text" class="form-control border-0 bg-light" [(ngModel)]="selectedEntry.subject" placeholder="e.g. Maths Class">
          </div>
        </div>
        <div class="modal-footer bg-light border-0 p-3">
          <button class="btn btn-outline-secondary rounded-pill px-4" (click)="selectedEntry = null">Cancel</button>
          <button class="btn btn-primary rounded-pill px-4 shadow" (click)="saveEdit()" [disabled]="isLoading">
            {{ isLoading ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}